# 2.5 Payment State Machine (Beginner-Friendly)

A **Payment State Machine** defines the allowed lifecycle of a payment.
It prevents invalid transitions such as capturing a failed payment or refunding an uncaptured one.

In Ethian, the payment state machine is **central to correctness**.

---

## 2.5.1 Why a Payment State Machine is required

Payments are not instantaneous or guaranteed.
They involve:
- external gateways,
- retries,
- partial failures,
- asynchronous confirmations.

Without a strict state machine:
- duplicate captures can occur,
- refunds may exceed captured amounts,
- ledger entries may become inconsistent.

---

## 2.5.2 Core Payment States

The primary payment states in Ethian are:

- **CREATED**  
  Payment object exists but no processor action taken yet.

- **AUTHORIZED**  
  Funds are reserved by the payment processor but not yet captured.

- **CAPTURED**  
  Funds are successfully captured and will move toward settlement.

- **FAILED**  
  Payment attempt failed and no funds were captured.

- **VOIDED**  
  Authorized payment was explicitly cancelled before capture.

- **REFUNDED**  
  Captured funds were returned (partially or fully).

> Some gateways may skip AUTHORIZED and move directly to CAPTURED.

---

## 2.5.3 Allowed State Transitions

Valid transitions are strictly controlled:

- CREATED → AUTHORIZED
- CREATED → CAPTURED
- CREATED → FAILED

- AUTHORIZED → CAPTURED
- AUTHORIZED → VOIDED
- AUTHORIZED → FAILED

- CAPTURED → REFUNDED

Invalid examples (must be rejected):
- FAILED → CAPTURED
- VOIDED → CAPTURED
- REFUNDED → CAPTURED

---

## 2.5.4 Idempotency Rules

Payment transitions must be **idempotent**.

Rules:
- Repeating the same capture request must not double-capture funds.
- Processor callbacks must be safely repeatable.
- State transitions must check current state before applying changes.

Example:
- If a payment is already CAPTURED, a second capture request must return success without side effects.

---

## 2.5.5 Ledger Impact by State

Ledger entries are created **only** on money-impacting transitions.

- AUTHORIZED → no ledger entry
- CAPTURED → ledger posting created
- REFUNDED → ledger posting created
- FAILED / VOIDED → no ledger impact

This ensures accounting reflects real money movement only.

---

## 2.5.6 Relationship with Invoice State

When a payment is linked to an invoice:
- CAPTURED payments contribute toward invoice balance.
- REFUNDED payments reduce invoice paid amount.

Invoice state updates occur via **domain events**, not direct mutation
(see 2.9 Domain Events Model).

---

## 2.5.7 Failure and Retry Handling

Retries do not change payment identity.
They are modeled as:
- repeated processor attempts under the same payment, or
- controlled retries with idempotency keys.

Rules:
- Retries must not violate payment invariants.
- Only one successful CAPTURE is allowed per payment.

---

## Summary

The Payment State Machine:
- defines what transitions are allowed,
- prevents invalid money movements,
- ensures ledger correctness.

It is one of the most critical safeguards in the Ethian domain model.

Next: see **2.6 Invoice State Machine**.