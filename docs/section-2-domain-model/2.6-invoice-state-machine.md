# 2.6 Invoice State Machine (Beginner-Friendly)

The **Invoice State Machine** defines the lifecycle of an invoice — a request for money.
Unlike payments, invoices can be:
- partially paid,
- paid via multiple payments,
- expired or cancelled without any payment.

---

## 2.6.1 Why an Invoice State Machine is required

Invoices represent **intent to collect money**, not the movement of money itself.

Without a strict state machine:
- invoices may be marked paid incorrectly,
- partial payments may be mishandled,
- overdue or expired invoices may still accept payments.

---

## 2.6.2 Core Invoice States

The primary invoice states in Ethian are:

- **DRAFT**  
  Invoice exists but is not yet issued to the customer.

- **ISSUED**  
  Invoice is active and awaiting payment.

- **PARTIALLY_PAID**  
  One or more payments captured, but total < invoice amount due.

- **PAID**  
  Invoice amount due has been fully satisfied by captured payments.

- **CANCELLED**  
  Invoice was cancelled by the merchant before full payment.

- **EXPIRED**  
  Invoice passed its due date without full payment.

---

## 2.6.3 Allowed State Transitions

Valid transitions are strictly controlled:

- DRAFT → ISSUED
- DRAFT → CANCELLED

- ISSUED → PARTIALLY_PAID
- ISSUED → PAID
- ISSUED → CANCELLED
- ISSUED → EXPIRED

- PARTIALLY_PAID → PARTIALLY_PAID
- PARTIALLY_PAID → PAID
- PARTIALLY_PAID → CANCELLED
- PARTIALLY_PAID → EXPIRED

Invalid examples (must be rejected):
- PAID → any other state
- CANCELLED → PAID
- EXPIRED → PAID

---

## 2.6.4 Relationship with Payments

Invoices do not directly control payments.
Instead:
- Payments reference an invoice.
- Payment CAPTURE events contribute to invoice balance.
- Payment REFUND events reduce invoice paid amount.

Invoice state changes are triggered by **domain events** (see 2.9).

---

## 2.6.5 Partial Payment Rules

Rules:
- Partial payments are allowed unless explicitly disabled by merchant configuration.
- Invoice remains PARTIALLY_PAID until total captured amount equals amount due.
- Overpayment must be rejected or handled explicitly (e.g., auto-refund).

---

## 2.6.6 Expiry Handling

Rules:
- Expiry is evaluated based on invoice `dueDate`.
- Expired invoices must not accept new payments.
- Late payment attempts must be rejected at payment creation or authorization time.

---

## 2.6.7 Cancellation Rules

Rules:
- Only DRAFT or ISSUED or PARTIALLY_PAID invoices may be cancelled.
- Cancelling an invoice does not automatically refund existing payments.
- Refunds (if needed) are explicit payment-level actions.

---

## Summary

The Invoice State Machine:
- governs how invoices evolve over time,
- supports partial payments safely,
- ensures invoices cannot be incorrectly paid or reopened.

Next: see **2.7 Ledger Model — Double Entry**.