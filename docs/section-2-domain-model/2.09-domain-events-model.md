# 2.9 Domain Events Model

Domain Events represent **important business facts** that have already happened in the Ethian domain.

They allow Ethian to:
- decouple services,
- publish state changes reliably,
- trigger downstream actions (ledger postings, webhooks, settlement flows).

A domain event is:
- immutable,
- time-stamped,
- associated with a specific aggregate change.

---

## 2.9.1 Why Domain Events exist in Ethian

Payments and financial systems require:
- auditability,
- traceability,
- idempotent propagation of changes.

If one service changes state (e.g., Payment CAPTURED),
other services must react without direct coupling.

Domain Events are the contract for that reaction.

---

## 2.9.2 What triggers a Domain Event

A Domain Event is emitted when an aggregate crosses a meaningful boundary such as:

- Payment status change (AUTHORIZED → CAPTURED)
- Invoice status change (ISSUED → PAID)
- Refund completion
- Settlement payout completion
- Webhook dispatch attempt (optional, depending on design)

Events are emitted **after** the aggregate state transition succeeds.

---

## 2.9.3 Common Domain Events (initial set)

### Payment Events
- `PaymentCreated`
- `PaymentAuthorized`
- `PaymentCaptureSucceeded`
- `PaymentCaptureFailed`
- `PaymentRefundRequested`
- `PaymentRefundSucceeded`
- `PaymentRefundFailed`

### Invoice Events
- `InvoiceIssued`
- `InvoicePartiallyPaid`
- `InvoicePaid`
- `InvoiceCancelled`
- `InvoiceExpired`

### Settlement Events
- `SettlementCreated`
- `SettlementPaid`
- `SettlementFailed`

### Ledger Events (internal-facing)
- `LedgerPostingCreated`
- `LedgerPostingFailed` (if posting pipeline exists)

---

## 2.9.4 Event Payload Shape (Beginner-Friendly)

A domain event payload should include:

- `eventId` (unique)
- `eventType`
- `occurredAt` (UTC timestamp)
- `merchantId`
- `aggregateType`
- `aggregateId`
- `version` (aggregate version or event schema version)
- `data` (event-specific fields)

Example:
- PaymentCaptureSucceeded includes:
  - paymentId
  - amount
  - currency
  - invoiceId (optional)
  - processorReference (optional)

---

## 2.9.5 Delivery and Idempotency Expectations

Even if the infrastructure guarantees ordering, real systems must assume:

- events may be delivered more than once,
- events may arrive out of order,
- consumers may crash mid-processing.

Therefore:
- consumers must be idempotent (safe to reprocess),
- eventId should be used for deduplication,
- consumers should validate state transitions before applying effects.

---

## 2.9.6 Relationship to Webhooks

Webhooks are a **delivery mechanism** for merchants.

- Domain Events are internal facts.
- Webhooks are external notifications derived from those facts.

A typical flow:
1. PaymentCaptureSucceeded is emitted
2. Webhook service consumes event
3. Webhook is sent to merchant endpoint
4. Delivery outcome is recorded separately (retries allowed)

---

## Summary

Domain Events connect the Ethian domain model across services.
They make state transitions observable, reliable, and decoupled.

Next: see **2.10 Serialization Rules**.