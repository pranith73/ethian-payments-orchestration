2.2 ER Diagram — Relationships Between Entities
(Version A — Deep, Professional, Beginner-Friendly, Single-Source)

2.2.1 High-Level Relationship Summary (Plain English)
Before diagrams, here is the relationship story in simple language:

A Merchant:
- issues many Invoices
- receives many Payments through Ethian
- receives many Settlements that transfer money to their bank
- has all of their financial truth recorded via LedgerEntries

A Customer:
- can receive many Invoices
- can attempt multiple Payments (retries, different methods)

A Product:
- can appear on multiple Invoices (e.g., subscription plans, items in cart)

An Invoice:
- belongs to exactly one Merchant and one Customer
- can be linked to zero, one, or multiple Payments (failed attempts, retries)

A Payment:
- belongs to exactly one Invoice and one Merchant
- generates multiple LedgerEntries
- may contribute to one Settlement once captured and settled

A Settlement:
- belongs to exactly one Merchant
- groups many Payments that were successfully captured
- is also represented in LedgerEntries (movement to merchant bank)

A LedgerEntry:
- belongs to one Merchant
- is linked to either a Payment, a Settlement, or both (depending on the entry type)

Domain Events:
- are linked to a single main entity (e.g., a specific Payment or Invoice)
- describe transitions such as “PaymentAuthorized”, “InvoicePaid”, “SettlementCompleted”

These relationships express the business reality that:
“Merchants bill customers (Invoices), customers pay (Payments...), and eventually transferred to the merchant (Settlements).”

2.2.2 ASCII ER Diagram (Beginner-Friendly View)
Below is a simple ASCII ERD showing the core relationships:

┌───────────────┐
│   Merchant    │
└──────┬────────┘
       │ 1
┌───────┼─────────────────────────────┐
│       │                             │
│       │                             │
▼       ▼                             ▼
┌────────────┐  ┌────────────┐         ┌───────────────┐
│  Invoice   │  │  Payment   │         │  Settlement   │
└────┬───────┘  └────┬───────┘         └──────┬────────┘
     │  *           │  *                      │  *
     │              │                         │
     │1             │*                        │*
     ▼              ▼                         ▼
┌────────────┐  ┌───────────────┐       ┌───────────────┐
│  Customer  │  │  LedgerEntry  │       │  DomainEvent  │
└────────────┘  └───────────────┘       └───────────────┘

2.2.3 Mermaid ER Diagram (Formal Relationship View)
For a more formal, tool-friendly representation, here is the same model in Mermaid ER format:

erDiagram
  MERCHANT ||--o{ INVOICE       : "issues"
  MERCHANT ||--o{ PAYMENT       : "receives via Ethian"
  MERCHANT ||--o{ SETTLEMENT    : "is paid through"
  MERCHANT ||--o{ LEDGER_ENTRY  : "has financial history"
  CUSTOMER ||--o{ INVOICE       : "is billed on"
  CUSTOMER ||--o{ PAYMENT       : "initiates"
  PRODUCT  }o--o{ INVOICE       : "appears on"
  INVOICE  ||--o{ PAYMENT       : "is paid by"
  PAYMENT  ||--o{ LEDGER_ENTRY  : "produces"
  SETTLEMENT ||--o{ PAYMENT     : "bundles"
  SETTLEMENT ||--o{ LEDGER_ENTRY: "records payout"
  %% Domain Events point to one main entity (e.g., Payment, Invoice, Settlement)
  PAYMENT    ||--o{ DOMAIN_EVENT : "emits"
  INVOICE    ||--o{ DOMAIN_EVENT : "emits"
  SETTLEMENT ||--o{ DOMAIN_EVENT : "emits"

2.2.4 Relationship Rules (Cardinality & Direction)

Merchant Relationships
Merchant → Invoice
- 1 Merchant : many Invoices
- Every Invoice belongs to exactly one Merchant
- Reason: invoices represent that merchant’s business transactions

Merchant → Payment
- 1 Merchant : many Payments
- Every Payment is associated with a single Merchant (no cross-merchant payments)

Merchant → Settlement
- 1 Merchant : many Settlements
- Each Settlement transfers funds only for that merchant

Merchant → LedgerEntry
- 1 Merchant : many LedgerEntries
- Ledger is always scoped per merchant; no cross-tenant entries

Customer Relationships
Customer → Invoice
- 1 Customer : many Invoices
- Each Invoice belongs to exactly one Customer

Customer → Payment
- 1 Customer : many Payments (attempts)
- A customer may attempt multiple payment methods or retries

Product Relationships
Product ↔ Invoice
- One invoice can contain many products (line items)
- One product can appear on many invoices
- Formal modeling: typically via an invoice line item structure (conceptually “many-to-many” between Product and Invoice)

Invoice Relationships
Invoice → Merchant
- Many Invoices → one Merchant

Invoice → Customer
- Many Invoices → one Customer

Invoice → Payment
- 1 Invoice : 0..n Payments
- Zero payments: invoice created but not yet paid
- One payment: happy path, first attempt succeeds
- Multiple payments: retries, different methods, failed attempts

Payment Relationships
Payment → Invoice
- Many Payments → one Invoice

Payment → LedgerEntry
- 1 Payment : many LedgerEntries
- Each Payment produces multiple accounting records

Settlement Relationships
Settlement → Payment
- 1 Settlement : many Payments
- A settlement bundles multiple captured payments

Settlement → LedgerEntry
- Settlement is also represented as ledger entries (payout movement)

Domain Events Relationships
- Domain events link back to one main entity (Payment, Invoice, Settlement)
- Events exist to describe state transitions and lifecycle changes

2.2.5 Beginner Mental Model
You can think of the relationships like this:

- Merchant = the shop
- Customer = the shopper
- Product = the item on the shelf
- Invoice = the bill for specific products to a specific customer
- Payment = the customer’s attempt to pay the bill
- LedgerEntry = each line in the shop’s accounting notebook
- Settlement = the moment the money from all those payments is transferred into the shop’s bank account
- Domain Events = system notifications that say: “Invoice created”, “Payment captured”, “Settlement completed”

The ER diagram makes sure this story is consistent and unambiguous across the entire system.
