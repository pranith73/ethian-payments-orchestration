# 2.4 Aggregates & Invariants (Beginner-Friendly)

An **Aggregate** is a cluster of domain objects treated as a single unit for consistency.
Each aggregate has one entry point called the **Aggregate Root**.

An **Invariant** is a rule that must always be true inside an aggregate.
If an invariant is violated, the system must reject the change.

Why this matters in Ethian:
- Payments are sensitive to duplicates, partial failures, and retries.
- Strong invariants prevent money and state from drifting into impossible combinations.

---

## 2.4.1 Aggregate Roots in Ethian (high-level)

In Ethian, the typical aggregate roots are:

- **Merchant**
- **Invoice**
- **Payment**
- **Ledger Transaction (Posting)**
- **Settlement**

> Note: This is a documentation-level model. The exact storage model can evolve, but the consistency boundaries must remain stable.

---

## 2.4.2 Merchant Aggregate

**Root:** Merchant  
**Owns:** merchant configuration, webhook subscriptions, settlement destinations.

Key invariants:
- A Merchant must have a stable `merchantId`.
- A Merchant must be in a valid status to accept new payments (e.g., active vs suspended).
- Webhook subscription endpoints must be valid before enabling delivery.

Consistency boundary:
- Merchant configuration changes are consistent within the Merchant aggregate.
- Payments and invoices reference `merchantId` but are not modified “inside” Merchant.

---

## 2.4.3 Invoice Aggregate

**Root:** Invoice  
**Owns:** amount due, currency, status, and invoice-level state transitions.

Key invariants:
- `amountDue` must be non-negative.
- Currency for an invoice is immutable once issued.
- Invoice status transitions must follow the Invoice state machine (see 2.6).
- Invoice cannot be marked **Paid** unless total successful captured amount equals invoice amount due (supports partial payments via states).

Consistency boundary:
- All invoice state transitions happen through the Invoice root.
- Payments may reference an invoice, but they do not directly mutate invoice fields without a controlled invoice transition.

---

## 2.4.4 Payment Aggregate

**Root:** Payment  
**Owns:** payment amount, currency, status, and payment-level state transitions.

Key invariants:
- Payment `amount` must be > 0 (for a standard payment).
- Payment currency is immutable for the lifetime of the payment.
- Payment status transitions must follow the Payment state machine (see 2.5).
- A Payment must not be captured more than once for the same payment identity (idempotent capture rule).
- Refund total must never exceed captured amount for that payment.

Consistency boundary:
- All payment lifecycle changes are controlled by the Payment root.
- Processor attempts (if modeled) belong to the payment and must not violate idempotency.

---

## 2.4.5 Ledger Posting Aggregate (Ledger Transaction)

**Root:** Ledger Transaction (Posting)  
**Owns:** a set of ledger entries that must balance.

Key invariants:
- Sum(debits) == Sum(credits) for a posting.
- Every entry must reference a valid ledger account.
- Every posting must reference a business reason (payment/refund/settlement).
- Postings are immutable once posted (append-only accounting).

Consistency boundary:
- Ledger postings are created as an atomic unit (all entries or none).
- Ledger is the system of record for financial truth (see 2.7).

---

## 2.4.6 Settlement Aggregate

**Root:** Settlement  
**Owns:** payout status and payout lifecycle for merchant transfers.

Key invariants:
- Settlement amount must be >= 0.
- Settlement status transitions are controlled and must be monotonic (no “paid back to pending”).
- Settlement must be traceable to source payments/postings used for the payout.

Consistency boundary:
- Settlement represents the lifecycle of payout execution and reconciliation.

---

## 2.4.7 Cross-aggregate rules (handled via events)

Some rules span multiple aggregates. We do not enforce them by direct cross-object mutation.
Instead, we coordinate via **domain events** (see 2.9), such as:
- Payment captured → Invoice updates to partially_paid/paid
- Payment refunded → Invoice / ledger updated accordingly
- Settlement paid → ledger posting created and settlement finalized

---

## Summary

Aggregates define **where consistency must be immediate**.
Domain events help enforce **cross-aggregate consistency** without tight coupling.

Next: see **2.5 Payment State Machine**.